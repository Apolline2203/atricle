---
title: "R Notebook"
output: github_document
---

```{r}
library(gitcreds)
gitcreds_set()
```



#on lit le fichier de métadonées et le stocke dans
```{r}
metadata<-read.csv(file="metadonee3.csv", sep = ";")
```


```{r}
library(dada2); packageVersion("dada2")
```
```{r}
path <- "/home/rstudio/atricle/sequences"
list.files(path)
```
```{r}
fn <- sort(list.files(path, pattern=".fastq.gz", full.names = TRUE))
sample.names <- sapply(strsplit(basename(fn), ".fastq.gz"), `[`, 1)
```

```{r}
plotQualityProfile(fn[1:2])
```

```{r}
filtFn <- file.path(path, "filtered", paste0(sample.names, "_filt.fastq.gz"))
```

```{r}
names(filtFn) <- sample.names
```

```{r}
out <- filterAndTrim(fn, filtFn, truncLen=c(450),
              maxN=0, maxEE=c(2), truncQ=2, rm.phix=TRUE,
              compress=TRUE, multithread=FALSE) # On Windows set multithread=FALSE
head(out)
```

```{r}
errFn <- learnErrors(filtFn, multithread=TRUE)
```

```{r}
plotErrors(errFn, nominalQ=TRUE)
```

```{r}
dadaFn <- dada(filtFn, err=errFn, multithread=TRUE)
```
```{r}
dadaFn[[1]]
```
#Les séquences sont déjà mergées donc j'ai passé l'étape "merge paired reads"
```{r}
seqtab <- makeSequenceTable(dadaFn)
dim(seqtab)
```
```{r}
# Inspect distribution of sequence lengths
table(nchar(getSequences(seqtab)))
```
#Remove chimeras

```{r}
seqtab.nochim <- removeBimeraDenovo(seqtab, method="consensus", multithread=TRUE, verbose=TRUE)
dim(seqtab.nochim)
sum(seqtab.nochim)/sum(seqtab)
```
#94 % de mes données sont conservées et 6% sont des chimères qui ont été enlevées.

#Track reads through the pipeline
```{r}
getN <- function(x) sum(getUniques(x))
track <- cbind(out, sapply(dadaFn, getN), rowSums(seqtab.nochim))

colnames(track) <- c("input", "filtered", "denoiseFn", "nonchim")
rownames(track) <- sample.names
head(track)
```
#Assign taxonomy
```{r}
getwd()
```

```{r}
taxa <- assignTaxonomy(seqtab.nochim, "/home/rstudio/atricle/silva_nr99_v138.1_train_set.fa.gz?download=1", multithread=TRUE)
```

```{r}
taxa.print <- taxa 
rownames(taxa.print) <- NULL
head(taxa.print)
```
# Il n'y a pas de Mock sample dans notre jeu de données

#Handoff to phyloseq

```{r}
library(phyloseq); packageVersion("phyloseq")
```
```{r}
library(Biostrings); packageVersion("Biostrings")
```

```{r}
library(ggplot2); packageVersion("ggplot2")
```

```{r}
theme_set(theme_bw())
```



#préparation des données pour faire les graphiques de l'abondance des phylums


```{r}
samples.out <- metadata$Run  # Utilisation de 'Run' comme identifiant d'échantillon
type_echantillon <- metadata$type_echantillon
localisation <- metadata$localisation
Run<- metadata$Run
```

```{r}
# Construire la table des métadonnées
samdf <- data.frame(
  Run = Run,
  Sample = samples.out,
  Type = type_echantillon,
  Location = localisation
)
```


```{r}
# Utiliser les noms des échantillons comme identifiants
rownames(samdf) <- samples.out

# Aperçu des métadonnées créées
head(samdf)
```

#graphique de l'abondance des différents phylums dans chaque échantillons
```{r}


# Vérification des dimensions
if (!all(rownames(samdf) %in% rownames(seqtab.nochim))) {
  stop("Les noms des échantillons dans 'samdf' ne correspondent pas à ceux de 'seqtab.nochim'.")
}

#  Création de l'objet phyloseq
ps <- phyloseq(
  otu_table(seqtab.nochim, taxa_are_rows = FALSE),
  sample_data(samdf),
  tax_table(taxa)
)

#  Résumé et visualisation
print(ps)
plot_richness(ps, measures = c("Shannon", "Simpson"))
# Barplot avec remplissage par Phylum
plot_bar(ps, fill = "Phylum") +
  ggtitle("Composition taxonomique par Phylum")


```
#le même graphique mais d'une manière différente
```{r}
# Extraire les données de phyloseq
data <- psmelt(ps)



# Assurez-vous que data contient bien les colonnes nécessaires
head(data)  # Vérifiez qu'il y a "Sample", "Abundance", et "Family"

# Créez le graphique
ggplot(data, aes(x = Sample, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity", position = "stack") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Composition taxonomique par Famille")




```

#graphique de l'abondance des phylums en foction du type d'échantillon : 
```{r}
# Extraire les données de phyloseq
data <- psmelt(ps)

# Vérifiez que les colonnes nécessaires sont présentes
head(data)  # Assurez-vous que "Type", "Abundance", et "Phylum" sont disponibles

# Créez le graphique avec Type et Phylum
ggplot(data, aes(x = Type, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity", position = "stack") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Composition taxonomique par Phylum selon le Type d'échantillon") +
  labs(x = "Type d'échantillon", y = "Abondance", fill = "Phylum")

```
# 1 seul graphique de l'abondance des phylum en fonction du type d'échantillon et de la localisation
```{r}
# Extraire les données de phyloseq
data <- psmelt(ps)

# Vérifiez que les colonnes nécessaires sont disponibles
head(data)  # Vérifiez qu'il y a "Type", "Location", "Abundance", et "Phylum"

# Créez le graphique avec Phylum, Type et Location
ggplot(data, aes(x = Type, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ Location, scales = "free_x") +  # Crée des facettes pour chaque localisation
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Composition taxonomique par Phylum, Type et Localisation") +
  labs(x = "Type d'échantillon", y = "Abondance", fill = "Phylum")

```





#création du l'objet Phyloseq : 
```{r}
ps <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows=FALSE), 
               sample_data(samdf), 
               tax_table(taxa))
```

```{r}
dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps)))
ps
```

#Visualize alpha-diversity:
```{r}
plot_richness(ps, x="Type", measures=c("Shannon", "Simpson", "Chao1"), color="Location")
```
# Première figure : barreplot des phylums : 
#charger les librairies
```{r}
library(phyloseq)
library(ggplot2)
```
# Charger l'objet phyloseq (ps)
# Assurez-vous que votre objet ps est correctement configuré
# Vérifiez que votre objet contient des données OTU, taxonomiques et d'échantillons

```{r}
ps
```


# Transformer les données en pourcentages (abondances relatives)
```{r}
ps_relative <- transform_sample_counts(ps, function(x) x / sum(x) * 100)
```


# Regrouper les données par le niveau taxonomique souhaité (par exemple, le phylum)
```{r}
ps_phylum <- tax_glom(ps_relative, taxrank = "Phylum")
```
```{r}
# Préparer les données pour ggplot
df <- psmelt(ps_phylum) # Convertit les données phyloseq en data.frame
df$Phylum <- as.character(df$Phylum)
df$Phylum[is.na(df$Phylum)] <- "Unassigned" # Gérer les taxons non assignés

# Trier les phylums par abondance moyenne
top_phyla <- names(sort(tapply(df$Abundance, df$Phylum, mean), decreasing = TRUE)[1:15])
df$Phylum <- factor(df$Phylum, levels = c(top_phyla, "Other"))

# Regrouper les phylums moins abondants sous "Other"
df$Phylum[!(df$Phylum %in% top_phyla)] <- "Other"

# Créer le barplot empilé
ggplot(df, aes(x = Sample, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c(
    rainbow(length(unique(df$Phylum))) # Génère des couleurs pour chaque phylum
  )) +
  labs(x = "Samples", y = "Relative Abundance (%)", fill = "Phylum") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```


#RDA Analysis
```{r}
# Charger les bibliothèques nécessaires
library(vegan)
library(ggplot2)

# Exemple de données d'abondance OTU (remplacez par vos données)
otu_data <- matrix(c(20, 15, 30, 10,
                     25, 20, 35, 5,
                     10, 25, 20, 15,
                     30, 10, 15, 25),
                   nrow = 4, byrow = TRUE)
rownames(otu_data) <- c("RP-S1", "RP-S2", "RP-S3", "RP-S4")
colnames(otu_data) <- c("OTU1", "OTU2", "OTU3", "OTU4")

# Tableau des variables environnementales 
env_data <- data.frame(
  Moisture_pourcentage = c(12.60, 8.26, 2.33, 11.11, 17.89, 6.49),
  pH = c(4.59, 4.63, 6.06, 6.53, 6.15, 6.04),
  NO3_mg.kg.drysample = c(0.604, 0.522, 0.261, 0.397, 0.447, 0.396),
  NH4_mg.kg.drysample = c(1.582, 1.350, 0.239, 0.461, 0.426, 0.201),
  NO2_µg.kg.drysample = c(71.493, 33.229, 4.334, 4.497, 3.345, 2.968)
)
rownames(env_data) <- c("BM-S1", "BM-S2", "RP-S1", "RP-S2", "RP-S3", "RP-S4")

# Exécuter l'analyse RDA
rda_result <- rda(otu_data ~ ., data = env_data)

# Résumé des résultats
summary(rda_result)

# Tracer l'analyse RDA
plot(rda_result, scaling = 2, main = "RDA - Abundance vs Environment")
arrows(0, 0, rda_result$biplot[,1], rda_result$biplot[,2], col = "blue", length = 0.1)
text(rda_result$biplot[,1], rda_result$biplot[,2], labels = rownames(rda_result$biplot), col = "blue", cex = 0.8)

#  visualisation améliorée avec ggplot2
library(ggvegan)

autoplot(rda_result, scaling = 2) +
  geom_point(size = 3) +
  geom_text(aes(label = rownames(env_data)), vjust = -1, hjust = 0.5) +
  theme_minimal() +
  labs(title = "RDA Analysis", x = "RDA1", y = "RDA2")

```







#analyse en composante pricipale : 
```{r}
# Charger les bibliothèques nécessaires
library(vegan)
library(ggplot2)
library(factoextra)

# Exemple de données (remplacez par vos propres données)
# Composition bactérienne (%) dans différents échantillons
bacteria_data <- matrix(c(
  0.10, 0.15, 0.05, 0.20, 0.50,  # BM-F1
  0.08, 0.12, 0.04, 0.25, 0.51,  # BM-F2
  0.30, 0.25, 0.15, 0.10, 0.20,  # RP-S1
  0.28, 0.22, 0.18, 0.12, 0.20,  # RP-S2
  0.35, 0.30, 0.05, 0.10, 0.20,  # RP-F1
  0.36, 0.32, 0.06, 0.08, 0.18   # RP-F2
), nrow = 6, byrow = TRUE)

rownames(bacteria_data) <- c("BM-F1", "BM-F2", "RP-S1", "RP-S2", "RP-F1", "RP-F2")
colnames(bacteria_data) <- c("Genus1", "Genus2", "Genus3", "Genus4", "Genus5")

# Effectuer l'analyse en composantes principales (ACP)
pca_result <- rda(bacteria_data)

# Résumé des résultats
summary(pca_result)

# Tracer les résultats de l'ACP avec ggplot2
pca_scores <- scores(pca_result, display = "sites")
pca_biplot <- data.frame(
  PC1 = pca_scores[, 1],
  PC2 = pca_scores[, 2],
  Sample = rownames(pca_scores)
)

ggplot(pca_biplot, aes(x = PC1, y = PC2, label = Sample)) +
  geom_point(aes(color = Sample), size = 3) +
  geom_text(vjust = -0.5, size = 3) +
  theme_minimal() +
  labs(title = "ACP des échantillons",
       x = paste0("PC1 (", round(summary(pca_result)$cont$importance[2, 1] * 100, 2), "%)"),
       y = paste0("PC2 (", round(summary(pca_result)$cont$importance[2, 2] * 100, 2), "%)")) +
  theme(legend.position = "none")

# Option pour ajouter des ellipses pour les groupes si applicables
# Exemple de regroupement des échantillons
groups <- c("Beng Mealea Biofilm", "Beng Mealea Biofilm", 
            "Royal Palace Sediment", "Royal Palace Sediment", 
            "Royal Palace Biofilm", "Royal Palace Biofilm")

fviz_pca_ind(pca_result, geom = "point", label = "var", habillage = groups, addEllipses = TRUE, ellipse.level = 0.95) +
  theme_minimal()

```












